<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–∞—Å—á—ë—Ç –≤–µ—á–µ—Ä–∏–Ω–∫–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <style>
    html, body {
      height: auto;
      min-height: 100vh;
      overflow-y: scroll;
      -webkit-overflow-scrolling: touch;
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: linear-gradient(145deg, #f0f0f0, #ffffff);
      color: #333;
    }
    h1 {
      text-align: center;
      margin: 12px 10px 4px;
      font-size: 14px;
    }
    form {
      background: #fff;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 10px 0;
    }
    label span {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    input[type="number"] {
      width: 100px;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    input[type="checkbox"] {
      margin-left: 10px;
    }
    button {
      width: 100%;
      background: #007bff;
      color: #fff;
      font-weight: 600;
      border: none;
      padding: 12px;
      margin-top: 20px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    #result, #summary {
      margin: 30px auto;
      max-width: 500px;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      font-size: 15px;
    }
    .line {
      margin: 6px 0;
    }
    .name {
      color: #006400;
      font-weight: bold;
    }
    .amount {
      color: #ff8c00;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üçæ –†–∞—Å—á—ë—Ç –≤–µ—á–µ—Ä–∏–Ω–∫–∏</h1>
  <form id="partyForm"></form>
  <div id="result"></div>
  <button onclick="resetData()">–°—Ç–µ—Ä–µ—Ç—å —Ä–∞—Å—á—ë—Ç—ã</button>
  <script>
    const endpoint = 'https://script.google.com/macros/s/AKfycbwd9H6HDIiTgsiPuIOWb07tVrBllZB_tzxIV8wH11W0jmuYv64KNRzmT7d-40JHwmFWNA/exec'; // –∑–∞–º–µ–Ω–∏—à—å –Ω–∞ —Å–≤–æ–π
    const names = [
      "–Ø–Ω–∞ –°–∞–π–≥–æ–Ω", "–ü–∞—à–∞ –°–∞–π–≥–æ–Ω", "–û–ª–µ—Å—è", "–°–ª–∞–≤–∞",
      "–¢–∞–Ω—è", "–ü–∞—à–∞ –ü–µ—Ä—Å–∏–∫", "–û–ª—è", "–Ø–Ω–∞ –ê—Ä—á–∏", "–°–∞—à–∞"
    ];
    const emojis = ["üê∂", "üçï", "üç∑", "ü•©", "üéâ", "üßÄ", "üç∫", "üçí", "üçæ"];

    function renderForm(saved = {}) {
      const container = document.getElementById('partyForm');
      container.innerHTML = '';
      names.forEach((name, i) => {
        const emoji = emojis[i];
        const item = document.createElement('label');
        item.innerHTML = `
          <span>${emoji} ${name}</span>
          <span>
            <input type="number" name="spent" data-name="${name}" placeholder="‚ÇΩ" value="${saved[name] || ''}">
            <label title="–ù–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª"><input type="checkbox" data-skip="${name}" ${saved[name] === null ? 'checked' : ''}></label>
          </span>`;
        container.appendChild(item);
      });
      const button = document.createElement('button');
      button.type = 'button';
      button.textContent = '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å';
      button.onclick = calculate;
      container.appendChild(button);
    }

    async function loadSavedData() {
      try {
        const res = await fetch(endpoint + '?action=party');
        const data = await res.json();
        const parsed = {};
        for (let name of names) {
          parsed[name] = data[name] === "SKIP" ? null : parseFloat(data[name] || '');
        }
        renderForm(parsed);
        if (Object.values(parsed).some(v => v !== '' && v !== null)) calculate();
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
        renderForm();
      }
    }

    async function calculate() {
      const inputs = document.querySelectorAll('input[name="spent"]');
      const skips = document.querySelectorAll('input[type="checkbox"]');
      const expenses = {};

      skips.forEach(ch => {
        if (ch.checked) expenses[ch.dataset.skip] = null;
      });
      inputs.forEach(input => {
        const name = input.dataset.name;
        if (!(name in expenses)) expenses[name] = parseFloat(input.value) || 0;
      });

      const participants = Object.keys(expenses).filter(name => expenses[name] !== null);
      const total = participants.reduce((sum, name) => sum + expenses[name], 0);
      const average = total / participants.length;
      const deltas = {};
      participants.forEach(name => deltas[name] = +(expenses[name] - average).toFixed(2));

      const creditors = participants.filter(n => deltas[n] > 0).sort((a, b) => deltas[b] - deltas[a]);
      const debtors = participants.filter(n => deltas[n] < 0).sort((a, b) => deltas[a] - deltas[b]);

      const transactions = [];
      let i = 0, j = 0;
      while (i < debtors.length && j < creditors.length) {
        const debtor = debtors[i];
        const creditor = creditors[j];
        const debt = Math.min(-deltas[debtor], deltas[creditor]);
        if (debt > 0.01) {
          transactions.push(`<div class="line"><span class="name">${debtor}</span> –¥–æ–ª–∂–µ–Ω <span class="amount">${debt}‚ÇΩ</span> ‚Üí <span class="name">${creditor}</span></div>`);
          deltas[debtor] += debt;
          deltas[creditor] -= debt;
        }
        if (Math.abs(deltas[debtor]) < 0.01) i++;
        if (Math.abs(deltas[creditor]) < 0.01) j++;
      }

      const result = document.getElementById('result');
      result.innerHTML = `<div id="summary"><strong>–û–±—â–∏–π —Å—á—ë—Ç: ${total}‚ÇΩ</strong><br>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${participants.length}<br>–°—Ä–µ–¥–Ω–∏–π –≤–∫–ª–∞–¥: ${average.toFixed(2)}‚ÇΩ</div>` + (transactions.length ? transactions.join('') : '<div class="line">–ù–∏–∫—Ç–æ –Ω–∏–∫–æ–º—É –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–µ–Ω</div>');

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      const payload = {};
      for (let name of names) {
        payload[name] = expenses[name] === null ? 'SKIP' : (expenses[name] || '');
      }
      try {
        await fetch(endpoint, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
      }
    }

    function resetData() {
      renderForm();
      document.getElementById('result').innerHTML = '';
    }

    loadSavedData();
  </script>
</body>
</html>
